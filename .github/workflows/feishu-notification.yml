name: é£ä¹¦æœºå™¨äººé€šçŸ¥

on:
  push:
    branches: [ main, master, develop, feature/*, hotfix/*, release/* ]
  pull_request:
    branches: [ main, master, develop ]
  create:
  delete:
  fork:
  gollum:
  issues:
  issue_comment:
  watch:
  release:
  deployment:
  deployment_status:
  public:
  repository_dispatch:

jobs:
  notify-feishu:
    runs-on: ubuntu-latest
    steps:
      - name: è·å–äº‹ä»¶ä¿¡æ¯
        id: event_info
        run: |
          echo "event_name=${{ github.event_name }}" >> $GITHUB_OUTPUT
          echo "ref=${{ github.ref }}" >> $GITHUB_OUTPUT
          echo "ref_name=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          echo "sha=${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "repository=${{ github.repository }}" >> $GITHUB_OUTPUT
          echo "actor=${{ github.actor }}" >> $GITHUB_OUTPUT
          echo "workflow=${{ github.workflow }}" >> $GITHUB_OUTPUT
          
          # è·å–æäº¤ä¿¡æ¯
          if [ "${{ github.event_name }}" = "push" ]; then
            echo "commit_message=$(git log --format=%B -n 1 ${{ github.sha }})" >> $GITHUB_OUTPUT
            echo "commit_author=$(git log --format=%an -n 1 ${{ github.sha }})" >> $GITHUB_OUTPUT
            echo "commit_date=$(git log --format=%cd -n 1 ${{ github.sha }})" >> $GITHUB_OUTPUT
          fi
          
          # è·å–PRä¿¡æ¯
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "pr_title=${{ github.event.pull_request.title }}" >> $GITHUB_OUTPUT
            echo "pr_body=${{ github.event.pull_request.body }}" >> $GITHUB_OUTPUT
            echo "pr_author=${{ github.event.pull_request.user.login }}" >> $GITHUB_OUTPUT
          fi

      - name: å‘é€é£ä¹¦é€šçŸ¥
        run: |
          # æ„å»ºæ¶ˆæ¯å†…å®¹
          PROJECT_NAME="yishe-scripts"
          EVENT_NAME="${{ steps.event_info.outputs.event_name }}"
          BRANCH="${{ steps.event_info.outputs.ref_name }}"
          REPOSITORY="${{ steps.event_info.outputs.repository }}"
          ACTOR="${{ steps.event_info.outputs.actor }}"
          SHA="${{ steps.event_info.outputs.sha }}"
          
          # æ ¹æ®äº‹ä»¶ç±»å‹æ„å»ºä¸åŒçš„æ¶ˆæ¯
          case $EVENT_NAME in
            "push")
              COMMIT_MSG="${{ steps.event_info.outputs.commit_message }}"
              COMMIT_AUTHOR="${{ steps.event_info.outputs.commit_author }}"
              COMMIT_DATE="${{ steps.event_info.outputs.commit_date }}"
              
              MESSAGE="ğŸš€ **ä»£ç æ¨é€é€šçŸ¥**
              
              ğŸ“ **é¡¹ç›®**: $PROJECT_NAME
              ğŸŒ¿ **åˆ†æ”¯**: $BRANCH
              ğŸ‘¤ **æäº¤è€…**: $ACTOR
              ğŸ“ **æäº¤ä¿¡æ¯**: $COMMIT_MSG
              ğŸ‘¨â€ğŸ’» **ä½œè€…**: $COMMIT_AUTHOR
              ğŸ“… **æäº¤æ—¶é—´**: $COMMIT_DATE
              ğŸ”— **ä»“åº“**: https://github.com/$REPOSITORY
              ğŸ”— **æäº¤é“¾æ¥**: https://github.com/$REPOSITORY/commit/$SHA"
              ;;
              
            "pull_request")
              PR_TITLE="${{ steps.event_info.outputs.pr_title }}"
              PR_BODY="${{ steps.event_info.outputs.pr_body }}"
              PR_AUTHOR="${{ steps.event_info.outputs.pr_author }}"
              
              MESSAGE="ğŸ”€ **Pull Request é€šçŸ¥**
              
              ğŸ“ **é¡¹ç›®**: $PROJECT_NAME
              ğŸŒ¿ **åˆ†æ”¯**: $BRANCH
              ğŸ‘¤ **åˆ›å»ºè€…**: $PR_AUTHOR
              ğŸ“ **PRæ ‡é¢˜**: $PR_TITLE
              ğŸ“„ **PRæè¿°**: $PR_BODY
              ğŸ”— **ä»“åº“**: https://github.com/$REPOSITORY
              ğŸ”— **PRé“¾æ¥**: ${{ github.event.pull_request.html_url }}"
              ;;
              
            "create")
              MESSAGE="âœ¨ **åˆ†æ”¯åˆ›å»ºé€šçŸ¥**
              
              ğŸ“ **é¡¹ç›®**: $PROJECT_NAME
              ğŸŒ¿ **åˆ†æ”¯**: $BRANCH
              ğŸ‘¤ **åˆ›å»ºè€…**: $ACTOR
              ğŸ”— **ä»“åº“**: https://github.com/$REPOSITORY"
              ;;
              
            "delete")
              MESSAGE="ğŸ—‘ï¸ **åˆ†æ”¯åˆ é™¤é€šçŸ¥**
              
              ğŸ“ **é¡¹ç›®**: $PROJECT_NAME
              ğŸŒ¿ **åˆ†æ”¯**: $BRANCH
              ğŸ‘¤ **åˆ é™¤è€…**: $ACTOR
              ğŸ”— **ä»“åº“**: https://github.com/$REPOSITORY"
              ;;
              
            *)
              MESSAGE="ğŸ“¢ **Gitäº‹ä»¶é€šçŸ¥**
              
              ğŸ“ **é¡¹ç›®**: $PROJECT_NAME
              ğŸŒ¿ **åˆ†æ”¯**: $BRANCH
              ğŸ‘¤ **æ“ä½œè€…**: $ACTOR
              ğŸ“‹ **äº‹ä»¶ç±»å‹**: $EVENT_NAME
              ğŸ”— **ä»“åº“**: https://github.com/$REPOSITORY"
              ;;
          esac
          
          # å‘é€åˆ°é£ä¹¦æœºå™¨äºº
          curl -X POST \
            -H "Content-Type: application/json" \
            -d "{
              \"msg_type\": \"post\",
              \"content\": {
                \"post\": {
                  \"zh_cn\": {
                    \"title\": \"Gitæ“ä½œé€šçŸ¥ - $PROJECT_NAME\",
                    \"content\": [
                      [
                        {
                          \"tag\": \"text\",
                          \"text\": \"$MESSAGE\"
                        }
                      ]
                    ]
                  }
                }
              }
            }" \
            "https://open.feishu.cn/open-apis/bot/v2/hook/143ed889-eace-42df-ba97-d8b2bac28e6d" 