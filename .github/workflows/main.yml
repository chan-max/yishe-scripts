name: Backup s1 DB from Remote Server with Password SSH

on:
  push:
    branches:
      - main
  schedule:
    - cron: '0 3 * * *'  # æ¯å¤©å‡Œæ™¨ 3 ç‚¹æ‰§è¡Œ
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Install sshpass & curl
        run: sudo apt-get update && sudo apt-get install -y sshpass curl

      - name: Run Backup Command on Remote Server
        run: |
          sshpass -p "${{ secrets.SERVER_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USERNAME }}@${{ secrets.SERVER_HOST }} "
            mysqldump -u${{ secrets.DATABASE_USERNAME }} -p'${{ secrets.DATABASE_PASSWORD }}' s1 > ~/backup.sql &&
            gzip -f ~/backup.sql
          "

      - name: Copy Backup File
        run: |
          sshpass -p "${{ secrets.SERVER_PASSWORD }}" scp -o StrictHostKeyChecking=no \
            ${{ secrets.SERVER_USERNAME }}@${{ secrets.SERVER_HOST }}:~/backup.sql.gz ./backup.sql.gz

      - name: Save, Limit to 99 Backups, and Commit
        run: |
          mkdir -p db_backups
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          mv backup.sql.gz db_backups/backup_$TIMESTAMP.sql.gz
          # ä¿ç•™æœ€æ–°çš„ 99 ä¸ªå¤‡ä»½ï¼Œåˆ é™¤å¤šä½™çš„
          ls -1t db_backups/backup_*.sql.gz | tail -n +100 | xargs -r rm --

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add db_backups/backup_*.sql.gz
          git commit -m "Auto backup at $TIMESTAMP" || echo "No changes"
          git push

      - name: Send Feishu Notification
        run: |
          curl -X POST ${{ secrets.FEISHU_WEBHOOK_URL }} \
            -H "Content-Type: application/json" \
            -d '{
              "msg_type": "text",
              "content": {
                "text": "ğŸ‰ æ•°æ®åº“ s1 å¤‡ä»½æˆåŠŸï¼\n\nğŸ“Œ å¤‡ä»½ä¿¡æ¯ï¼š\nâ€¢ æ—¶é—´ï¼š'"$(date +'%Y-%m-%d %H:%M:%S')"'\nâ€¢ æœåŠ¡å™¨ï¼š${{ secrets.SERVER_HOST }}\n\nâœ¨ å¤‡ä»½æ–‡ä»¶å·²ä¸Šä¼ è‡³ä»“åº“ db_backups ç›®å½•ã€‚"
              }
            }'

      - name: Debug SSH Variables
        run: |
          echo "SERVER_USERNAME: ${{ secrets.SERVER_USERNAME }}"
          echo "SERVER_HOST: ${{ secrets.SERVER_HOST }}"
          echo "DATABASE_USERNAME: ${{ secrets.DATABASE_USERNAME }}"
